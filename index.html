<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>GARAGE STATS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: 'Orbitron', Arial, sans-serif; 
      background: linear-gradient(135deg, #1a1f24 0%, #25292e 100%);
      color: #eee; 
      overflow-x: hidden;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); filter: drop-shadow(0 0 0px #67ff84); }
      50% { transform: scale(1.08); filter: drop-shadow(0 0 15px #67ff84); }
    }
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .logo { 
      text-align: center; 
      margin-top: 24px; 
      animation: fadeIn 0.6s ease-out;
    }
    .logo-img { 
      width: 110px; 
      height: 110px;
      animation: pulse 2.5s ease-in-out infinite;
      filter: drop-shadow(0 0 8px rgba(103, 255, 132, 0.3));
    }
    .app-title { 
      font-size: 1.8em; 
      letter-spacing: 4px; 
      margin: 8px 0 6px 0; 
      background: linear-gradient(135deg, #67ff84, #4edd77);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .app-subtitle {
      font-size: 0.75em;
      color: #999;
      letter-spacing: 2px;
      margin-bottom: 20px;
    }

    .welcome { 
      background: linear-gradient(135deg, #32383e 0%, #2e343a 100%);
      border-radius: 16px; 
      margin: 20px 16px; 
      padding: 28px 20px; 
      text-align: center;
      border: 1px solid #67ff84;
      animation: slideInUp 0.5s ease-out;
    }
    .welcome h2 {
      margin-top: 0;
      color: #67ff84;
      font-size: 1.4em;
    }
    .welcome p {
      line-height: 1.6;
      color: #ccc;
      margin: 12px 0;
    }

    .hidden { display: none !important; }
    
    .tabs { 
      background: linear-gradient(to right, #2e343b, #25292e);
      display: flex; 
      position: fixed; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      height: 60px; 
      border-top: 2px solid #67ff84;
    }
    .tab { 
      flex: 1; 
      text-align: center; 
      padding-top: 12px; 
      font-size: 16px; 
      color: #888; 
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .tab:hover { 
      color: #67ff84;
    }
    .tab.active { 
      color: #67ff84; 
      font-weight: bold;
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: #67ff84;
    }

    .main-content { 
      padding-bottom: 80px; 
      min-height: 65vh; 
      animation: fadeIn 0.5s ease-out;
    }
    .section { 
      display: none;
      animation: fadeIn 0.4s ease-out;
    }
    .section.active { 
      display: block; 
    }

    .card { 
      background: linear-gradient(135deg, #32383e 0%, #2e343a 100%);
      border-radius: 14px; 
      margin: 16px 12px; 
      padding: 20px; 
      border: 1px solid rgba(103, 255, 132, 0.15);
      transition: all 0.3s ease;
    }
    .card:hover {
      border-color: rgba(103, 255, 132, 0.3);
      transform: translateY(-2px);
    }

    .card h3 {
      margin: 0 0 16px 0;
      font-size: 1.3em;
      color: #67ff84;
    }

    .input-group { 
      margin: 16px 0; 
    }
    label { 
      font-size: 16px;
      display: block;
      margin-bottom: 8px;
      color: #ccc;
    }
    input[type="number"], input[type="text"] { 
      width: 100%;
      max-width: 300px;
      border-radius: 6px; 
      border: 1px solid #555; 
      padding: 8px 10px; 
      font-size: 16px;
      background: #262c32;
      color: #67ff84;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    input[type="number"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: #67ff84;
      box-shadow: 0 0 8px rgba(103, 255, 132, 0.3);
    }

    select { 
      font-size: 16px; 
      padding: 8px 10px; 
      border-radius: 6px;
      background: #262c32;
      color: #67ff84;
      border: 1px solid #555;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    select:focus {
      outline: none;
      border-color: #67ff84;
      box-shadow: 0 0 8px rgba(103, 255, 132, 0.3);
    }

    button { 
      background: linear-gradient(135deg, #67ff84, #4edd77);
      color: #222; 
      border: none; 
      border-radius: 8px; 
      padding: 11px 22px; 
      font-size: 16px; 
      cursor: pointer; 
      font-family: inherit;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(103, 255, 132, 0.2);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(103, 255, 132, 0.4);
    }
    button:active { 
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(103, 255, 132, 0.2);
    }

    button.secondary { 
      background: linear-gradient(135deg, #4a5261, #3d4552);
      color: #ddd;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    button.secondary:hover {
      background: linear-gradient(135deg, #556278, #485563);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
    }

    button.small {
      padding: 6px 12px;
      font-size: 13px;
    }

    button.danger {
      background: linear-gradient(135deg, #ff6b6b, #ff5252);
    }
    button.danger:hover {
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }

    .currency-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 16px 0;
    }
    .currency-btn {
      background: #262c32;
      border: 2px solid #555;
      border-radius: 10px;
      padding: 14px 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      font-size: 14px;
      color: #aaa;
      font-family: inherit;
    }
    .currency-btn:hover {
      border-color: #67ff84;
      color: #67ff84;
    }
    .currency-btn.active {
      background: linear-gradient(135deg, #67ff84, #4edd77);
      border-color: #67ff84;
      color: #222;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(103, 255, 132, 0.3);
      transform: scale(1.05);
    }
    .currency-flag {
      font-size: 1.8em;
      display: block;
      margin-bottom: 4px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease-out;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: linear-gradient(135deg, #32383e 0%, #2e343a 100%);
      border-radius: 16px;
      padding: 24px;
      max-width: 350px;
      width: 90%;
      border: 2px solid #67ff84;
      animation: scaleIn 0.3s ease-out;
    }
    .modal-content h2 {
      margin: 0 0 16px 0;
      color: #67ff84;
      font-size: 1.3em;
    }
    .modal-content input {
      width: 100% !important;
      max-width: 100% !important;
      margin-bottom: 16px;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .modal-buttons button {
      flex: 1;
    }

    .fav-list { 
      margin-top: 16px; 
    }
    .fav-entry { 
      background: linear-gradient(135deg, #262c32 0%, #1f2428 100%);
      padding: 14px; 
      border-radius: 10px; 
      margin-bottom: 12px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      border: 1px solid rgba(103, 255, 132, 0.1);
      transition: all 0.3s ease;
      animation: slideInUp 0.3s ease-out;
    }
    .fav-entry:hover {
      border-color: rgba(103, 255, 132, 0.3);
      background: linear-gradient(135deg, #2e343a 0%, #262c32 100%);
    }
    .fav-entry-info {
      flex: 1;
    }
    .fav-entry-name {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 6px;
    }
    .fav-entry-stats {
      font-size: 13px;
      color: #999;
      line-height: 1.4;
    }
    .fav-entry-buttons {
      display: flex;
      gap: 6px;
      margin-left: 12px;
    }

    .tag {
      display: inline-block;
      background: #555;
      color: #eee;
      border-radius: 6px;
      font-size: 0.85em;
      padding: 3px 8px;
      margin-left: 8px;
      margin-right: 4px;
    }
    .tag-roundtrip { 
      background: linear-gradient(135deg, #67ff84, #4edd77);
      color: #222;
      font-weight: bold;
    }

    .currency-symbol { 
      font-weight: bold; 
      color: #67ff84;
      font-size: 1.05em;
    }

    .profile-card {
      background: linear-gradient(135deg, #32383e 0%, #2e343a 100%);
      border-radius: 14px;
      margin: 16px 12px;
      padding: 20px;
      border: 1px solid rgba(103, 255, 132, 0.15);
    }

    .profile-stat {
      margin: 14px 0;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(103, 255, 132, 0.05);
      border-radius: 8px;
      border-left: 3px solid #67ff84;
    }
    .profile-stat-label {
      color: #aaa;
    }
    .profile-stat-value { 
      color: #67ff84; 
      font-weight: bold;
      font-size: 1.1em;
    }

    .button-group { 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
      margin-top: 20px;
    }

    .empty-state {
      text-align: center;
      color: #666;
      padding: 24px;
      font-size: 14px;
    }

    .calc-result {
      background: rgba(103, 255, 132, 0.1);
      border-left: 3px solid #67ff84;
      border-radius: 8px;
      padding: 14px;
      margin: 14px 0;
      font-size: 16px;
      animation: slideInUp 0.4s ease-out;
    }

    .user-info {
      background: rgba(103, 255, 132, 0.05);
      border-left: 3px solid #67ff84;
      border-radius: 8px;
      padding: 14px;
      margin: 12px 0;
      font-size: 15px;
      word-break: break-word;
    }
    .user-info-label {
      color: #999;
      font-size: 13px;
    }
    .user-info-value {
      color: #67ff84;
      font-weight: bold;
      margin-top: 4px;
    }

    .custom-consumption {
      background: rgba(103, 255, 132, 0.05);
      border-left: 3px solid #67ff84;
      border-radius: 8px;
      padding: 14px;
      margin: 12px 0;
    }
    .custom-consumption h4 {
      margin: 0 0 12px 0;
      color: #67ff84;
    }
    .consumption-input-group {
      display: flex;
      gap: 8px;
      margin: 8px 0;
      align-items: center;
    }
    .consumption-input-group label {
      min-width: 80px;
      margin-bottom: 0;
      font-size: 14px;
    }
    .consumption-input-group input {
      flex: 1;
      max-width: 100px !important;
    }

    @media (max-width: 500px) {
      .currency-selector {
        grid-template-columns: repeat(3, 1fr);
      }
      .tab { font-size: 14px; padding-top: 14px; }
      .app-title { font-size: 1.5em; }
      .card { margin: 12px 8px; }
      .profile-card { margin: 12px 8px; }
      .fav-entry {
        flex-direction: column;
        align-items: flex-start;
      }
      .fav-entry-buttons {
        width: 100%;
        margin-left: 0;
        margin-top: 10px;
      }
      .fav-entry-buttons button {
        flex: 1;
      }
      .modal-content {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <div class="logo">
    <img src="logo.png" alt="GARAGE STATS" class="logo-img">
    <div class="app-title">GARAGE STATS</div>
    <div class="app-subtitle">‚ö° FUEL TRACKER ‚ö°</div>
  </div>

  <div id="welcome" class="welcome hidden">
    <h2>üöó –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
    <p>–≠—Ç–æ —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –∞–≤—Ç–æ.<br>
    –í–µ–¥–∏ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—Å–µ —Å–≤–æ–∏ —Ç—Ä–∞—Ç—ã –∏ –ø–æ–µ–∑–¥–∫–∏.<br>
    <b>–í–æ–¥–∞ –∫–∞–º–µ–Ω—å —Ç–æ—á–µ—Ç</b> üíß</p>
    <button onclick="closeWelcome()" style="margin-top:14px;">–ü–æ–≥–Ω–∞–ª–∏! üöÄ</button>
  </div>

  <!-- Modal –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-title">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
      <input type="text" id="modal-input" placeholder="–í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç">
      <div class="modal-buttons">
        <button class="secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button onclick="confirmModal()">OK</button>
      </div>
    </div>
  </div>

  <!-- –û–ù–ë–û–†–î–ò–ù–ì - –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ -->
  <div id="onboarding-modal" class="modal">
    <div class="modal-content">
      <h2 style="text-align:center;margin-bottom:20px;">üöó –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GARAGE STATS!</h2>
      
      <div class="input-group">
        <label style="margin-bottom:10px;">–£–∫–∞–∂–∏ —Å–≤–æ–π –Ω–∏–∫:</label>
        <input type="text" id="onboarding-nick" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Vovka_Garagist" maxlength="30" style="width:100%;margin-bottom:12px;">
      </div>

      <div class="input-group">
        <label style="margin-bottom:10px;">–í—ã–±–µ—Ä–∏ –≤–∞–ª—é—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:</label>
        <div class="currency-selector" style="margin-top:10px;">
          <div class="currency-btn active" onclick="selectOnboardingCurrency('RUB')" id="onboard-rub">
            <span class="currency-flag">üá∑üá∫</span>
            <div>RUB</div>
            <div style="font-size:12px;color:#999;">‚ÇΩ</div>
          </div>
          <div class="currency-btn" onclick="selectOnboardingCurrency('BYN')" id="onboard-byn">
            <span class="currency-flag">üáßüáæ</span>
            <div>BYN</div>
            <div style="font-size:12px;color:#999;">Br</div>
          </div>
          <div class="currency-btn" onclick="selectOnboardingCurrency('USD')" id="onboard-usd">
            <span class="currency-flag">üá∫üá∏</span>
            <div>USD</div>
            <div style="font-size:12px;color:#999;">$</div>
          </div>
        </div>
      </div>

      <button onclick="completeOnboarding()" style="width:100%;margin-top:20px;">–ù–∞—á–Ω—ë–º! üöÄ</button>
    </div>
  </div>

  <div class="main-content">
    <!-- –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† -->
    <div id="calc-section" class="section active">
      <div class="card">
        <h3>üíß –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∞—Å—Ö–æ–¥–∞</h3>
        <form id="calc-form" onsubmit="return false;">
          <div class="input-group">
            <label>–¢–∏–ø –µ–∑–¥—ã:</label>
            <select id="driveType" onchange="updateConsumption()">
              <option value="eco">üü¢ –≠–∫–æ–Ω–æ–º–Ω—ã–π</option>
              <option value="normal" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option>
              <option value="fast">üî¥ –ù–∞ –≤—Å–µ –±–∞–±–∫–∏</option>
            </select>
          </div>
          <div class="input-group">
            <label>–†–∞—Å—Ö–æ–¥ (–ª/100–∫–º): <b id="consumption">7.0</b></label>
          </div>
          <div class="input-group">
            <label>–î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º): <input type="number" id="distance" value="100" min="1" max="10000"/></label>
          </div>
          <div class="input-group">
            <label>–¶–µ–Ω–∞ —Ç–æ–ø–ª–∏–≤–∞ (<span id="price-currency-label">‚ÇΩ</span>/–ª): <input type="number" id="price" value="55" min="0.1" max="500" step="0.1"/></label>
          </div>
          <button type="button" onclick="calculate()" style="width:100%;">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
        </form>
        <div id="calc-result"></div>
        <button type="button" style="margin-top:10px;width:100%;" onclick="openFavModal()">‚òÜ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
      </div>

      <div class="card">
        <h3>‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</h3>
        <div id="fav-list" class="fav-list"></div>
      </div>
    </div>

    <!-- –ì–ê–†–ê–ñ -->
    <div id="garage-section" class="section">
      <div class="card">
        <h3>üöô –ì–∞—Ä–∞–∂</h3>
        <p style="color:#999;margin:14px 0;">–¢–≤–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –∂–µ–ª–µ–∑–Ω—ã—Ö –∫–æ–Ω–µ–π</p>
        <p style="color:#666;font-size:14px;margin-bottom:0;">(—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è!)</p>
      </div>
    </div>

    <!-- –ü–†–û–§–ò–õ–¨ -->
    <div id="profile-section" class="section">
      <!-- User Info -->
      <div class="profile-card">
        <h3>üë§  –¢–≤–æ—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        <div class="user-info">
          <div class="user-info-label">–ù–∏–∫:</div>
          <div class="user-info-value" id="profile-nick">–ù–µ —É–∫–∞–∑–∞–Ω</div>
          <button class="secondary small" onclick="editNick()" style="margin-top:8px;">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="user-info">
          <div class="user-info-label">–ú–∞—à–∏–Ω–∞:</div>
          <div class="user-info-value" id="profile-car">–ù–µ —É–∫–∞–∑–∞–Ω–∞</div>
          <button class="secondary small" onclick="editCar()" style="margin-top:8px;">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>

      <!-- Custom Consumption -->
      <div class="profile-card">
        <h3>‚õΩ –¢–≤–æ–π —Ä–∞—Å—Ö–æ–¥ (–ª/100–∫–º)</h3>
        <div class="custom-consumption">
          <div class="consumption-input-group">
            <label>üü¢ –≠–∫–æ–Ω–æ–º:</label>
            <input type="number" id="custom-eco" value="5.7" step="0.1" min="0.5" onchange="saveCustomConsumption()">
          </div>
          <div class="consumption-input-group">
            <label>üü° –°—Ä–µ–¥–Ω–∏–π:</label>
            <input type="number" id="custom-normal" value="7.2" step="0.1" min="0.5" onchange="saveCustomConsumption()">
          </div>
          <div class="consumption-input-group">
            <label>üî¥ –ù–∞ –≤—Å–µ:</label>
            <input type="number" id="custom-fast" value="10.5" step="0.1" min="0.5" onchange="saveCustomConsumption()">
          </div>
        </div>
      </div>

      <!-- Currency -->
      <div class="profile-card">
        <h3>üí± –í—ã–±–µ—Ä–∏ –≤–∞–ª—é—Ç—É:</h3>
        <div class="currency-selector">
          <div class="currency-btn active" onclick="selectCurrency('RUB')">
            <span class="currency-flag">üá∑üá∫</span>
            <div>RUB</div>
            <div style="font-size:12px;color:#999;">‚ÇΩ</div>
          </div>
          <div class="currency-btn" onclick="selectCurrency('BYN')">
            <span class="currency-flag">üáßüáæ</span>
            <div>BYN</div>
            <div style="font-size:12px;color:#999;">Br</div>
          </div>
          <div class="currency-btn" onclick="selectCurrency('USD')">
            <span class="currency-flag">üá∫üá∏</span>
            <div>USD</div>
            <div style="font-size:12px;color:#999;">$</div>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="profile-card">
        <h3>üìä –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h3>
        <div id="profile-info"></div>
      </div>

      <!-- Actions -->
      <div class="profile-card">
        <div class="button-group">
          <button class="secondary" onclick="openTelegram()" style="width:100%;">üí¨ –ü–æ–∂–µ–ª–∞–Ω–∏—è –∏ –∏–¥–µ–∏</button>
          <button class="secondary" onclick="clearAllData()" style="width:100%;">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
        </div>
      </div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('calc')">üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
    <div class="tab" onclick="switchTab('garage')">üöô –ì–∞—Ä–∞–∂</div>
    <div class="tab" onclick="switchTab('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
  </div>

  <script>
    // ========== –ö–û–ù–§–ò–ì (–°–¢–†–û–ö–ò 1-30) ==========
    const consumptionByType = { eco: 5.7, normal: 7.2, fast: 10.5 };
    const currencySymbols = { RUB: '‚ÇΩ', BYN: 'Br', USD: '$' };
    const defaultPrices = { RUB: 55, BYN: 2.6, USD: 1.8 };
    
    const exchangeRates = {
      RUB: 1,
      BYN: 0.047,
      USD: 0.0107
    };
    
    const telegramLink = 'https://t.me/History_deleted';
    let modalCallback = null;
    let lastCurrency = 'RUB';
    let selectedOnboardingCurrency = 'RUB';
    
    // TELEGRAM WEB APP
    let tg = window.Telegram.WebApp;
    if (tg) {
      tg.expand();
    }

    // ========== TELEGRAM AUTH (–°–¢–†–û–ö–ò 32-70) ==========
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö Telegram —é–∑–µ—Ä–∞
    function getTelegramUser() {
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        return tg.initDataUnsafe.user;
      }
      return null;
    }

    // –ü–æ–ª—É—á–∏—Ç—å –Ω–∏–∫ –∏–∑ Telegram –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ
    function getTelegramUsername() {
      const user = getTelegramUser();
      if (user && user.username) {
        return '@' + user.username;
      }
      if (user && user.first_name) {
        return user.first_name;
      }
      return '';
    }

    // ========== MODAL FUNCTIONS (–°–¢–†–û–ö–ò 72-100) ==========
    function openModal(title, defaultValue = '', callback) {
      document.getElementById('modal-title').innerText = title;
      document.getElementById('modal-input').value = defaultValue;
      document.getElementById('modal-input').focus();
      document.getElementById('modal').classList.add('active');
      modalCallback = callback;
    }
    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      modalCallback = null;
    }
    function confirmModal() {
      const value = document.getElementById('modal-input').value.trim();
      if (value && modalCallback) {
        modalCallback(value);
      }
      closeModal();
    }
    document.getElementById('modal-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') confirmModal();
      if (e.key === 'Escape') closeModal();
    });

    // ========== CURRENCY FUNCTIONS (–°–¢–†–û–ö–ò 102-160) ==========
    function convertPrice(amount, fromCurrency, toCurrency) {
      if (fromCurrency === toCurrency) return parseFloat(amount).toFixed(2);
      const toRUB = amount / exchangeRates[fromCurrency];
      return (toRUB * exchangeRates[toCurrency]).toFixed(2);
    }

    function getCurrency() {
      return localStorage.getItem('gs-currency') || 'RUB';
    }
    function setCurrency(curr) {
      localStorage.setItem('gs-currency', curr);
    }

    function selectCurrency(curr) {
      const favs = loadFavorites();
      
      if (favs.length > 0 && lastCurrency !== curr) {
        favs.forEach(f => {
          f.price = parseFloat(convertPrice(f.price, lastCurrency, curr));
        });
        saveFavorites(favs);
      }
      
      lastCurrency = curr;
      setCurrency(curr);
      updateCurrencyDisplay();
      updatePriceDefault();
      renderFavorites();
      updateProfile();
    }

    function updateCurrencyDisplay() {
      const curr = getCurrency();
      const symbol = currencySymbols[curr];
      document.getElementById('price-currency-label').innerText = symbol;
      
      document.querySelectorAll('.currency-btn').forEach((btn, idx) => {
        btn.classList.remove('active');
        if ((['RUB', 'BYN', 'USD'][idx]) === curr) {
          btn.classList.add('active');
        }
      });
    }

    function updatePriceDefault() {
      const curr = getCurrency();
      document.getElementById('price').value = defaultPrices[curr];
    }

    // ========== ONBOARDING FUNCTIONS (–°–¢–†–û–ö–ò 162-220) ==========
    function selectOnboardingCurrency(curr) {
      selectedOnboardingCurrency = curr;
      document.getElementById('onboard-rub').classList.remove('active');
      document.getElementById('onboard-byn').classList.remove('active');
      document.getElementById('onboard-usd').classList.remove('active');
      document.getElementById('onboard-' + curr.toLowerCase()).classList.add('active');
    }

    function completeOnboarding() {
      let nick = document.getElementById('onboarding-nick').value.trim();
      
      // –ï—Å–ª–∏ –Ω–∏–∫ –ø—É—Å—Ç, –±–µ—Ä–µ–º –∏–∑ Telegram
      if (!nick) {
        nick = getTelegramUsername();
        if (!nick) {
          alert('–£–∫–∞–∂–∏ —Å–≤–æ–π –Ω–∏–∫ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π Telegram!');
          return;
        }
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º
      setNick(nick);
      setCurrency(selectedOnboardingCurrency);
      lastCurrency = selectedOnboardingCurrency;
      
      // –ì–õ–ê–í–ù–û–ï: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –ø—Ä–æ—à–µ–ª!
      localStorage.setItem('gs-onboarded', '1');
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª
      document.getElementById('onboarding-modal').classList.remove('active');
      document.body.style.overflow = "";
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      updateCurrencyDisplay();
      updatePriceDefault();
      updateProfile();
    }

    function showOnboarding() {
      // –ü–†–û–í–ï–†–Ø–ï–ú: –µ—Å–ª–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ —É–∂–µ –ø—Ä–æ—à–µ–ª - –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º!
      if (!localStorage.getItem('gs-onboarded')) {
        // –ï—Å–ª–∏ –µ—Å—Ç—å Telegram —é–∑–µ—Ä - –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–∏–∫
        const tgNick = getTelegramUsername();
        if (tgNick) {
          document.getElementById('onboarding-nick').placeholder = tgNick;
          document.getElementById('onboarding-nick').value = tgNick;
        }
        
        document.getElementById('onboarding-modal').classList.add('active');
        document.body.style.overflow = "hidden";
      } else {
        // –û–Ω–±–æ—Ä–¥–∏–Ω–≥ —É–∂–µ –ø—Ä–æ—à–µ–ª - –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ—Ä–º
        updateCurrencyDisplay();
        updatePriceDefault();
        loadCustomConsumptionUI();
      }
    }

    // ========== USER INFO FUNCTIONS (–°–¢–†–û–ö–ò 222-260) ==========
    function getNick() {
      return localStorage.getItem('gs-nick') || '–ù–µ —É–∫–∞–∑–∞–Ω';
    }
    function setNick(nick) {
      localStorage.setItem('gs-nick', nick);
      updateProfile();
    }
    function editNick() {
      openModal('–£–∫–∞–∂–∏ —Å–≤–æ–π –Ω–∏–∫:', getNick(), setNick);
    }

    function getCar() {
      return localStorage.getItem('gs-car') || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
    }
    function setCar(car) {
      localStorage.setItem('gs-car', car);
      updateProfile();
    }
    function editCar() {
      openModal('–£–∫–∞–∂–∏ —Å–≤–æ—é –º–∞—à–∏–Ω—É:', getCar(), setCar);
    }

    // ========== CUSTOM CONSUMPTION FUNCTIONS (–°–¢–†–û–ö–ò 262-300) ==========
    function loadCustomConsumption() {
      return {
        eco: parseFloat(localStorage.getItem('gs-cons-eco')) || 5.7,
        normal: parseFloat(localStorage.getItem('gs-cons-normal')) || 7.2,
        fast: parseFloat(localStorage.getItem('gs-cons-fast')) || 10.5
      };
    }
    function saveCustomConsumption() {
      const eco = parseFloat(document.getElementById('custom-eco').value) || 5.7;
      const normal = parseFloat(document.getElementById('custom-normal').value) || 7.2;
      const fast = parseFloat(document.getElementById('custom-fast').value) || 10.5;
      
      localStorage.setItem('gs-cons-eco', eco);
      localStorage.setItem('gs-cons-normal', normal);
      localStorage.setItem('gs-cons-fast', fast);
      
      updateConsumption();
      renderFavorites();
    }

    function getConsumptionByType() {
      const custom = loadCustomConsumption();
      return { eco: custom.eco, normal: custom.normal, fast: custom.fast };
    }

    function loadCustomConsumptionUI() {
      const cons = loadCustomConsumption();
      document.getElementById('custom-eco').value = cons.eco;
      document.getElementById('custom-normal').value = cons.normal;
      document.getElementById('custom-fast').value = cons.fast;
    }

    // ========== TAB FUNCTIONS (–°–¢–†–û–ö–ò 302-330) ==========
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
      const tabIndex = ['calc', 'garage', 'profile'].indexOf(tab);
      document.querySelectorAll('.tab')[tabIndex].classList.add('active');
      document.getElementById(tab+'-section').classList.add('active');
      if (tab === 'profile') {
        updateProfile();
        loadCustomConsumptionUI();
      }
    }

    // ========== CALCULATOR FUNCTIONS (–°–¢–†–û–ö–ò 332-360) ==========
    function updateConsumption() {
      const t = document.getElementById('driveType').value;
      const consumptions = getConsumptionByType();
      document.getElementById('consumption').innerText = consumptions[t].toFixed(1);
    }
    updateConsumption();

    function calculate() {
      const type = document.getElementById('driveType').value;
      const distance = Number(document.getElementById('distance').value);
      const price = Number(document.getElementById('price').value);
      const cons = getConsumptionByType()[type];
      const currency = getCurrency();
      const symbol = currencySymbols[currency];

      const liters = cons * distance / 100;
      const cost = liters * price;
      
      document.getElementById('calc-result').innerHTML = `
        <div class="calc-result">
          –ü–æ—Ç—Ä–∞—Ç–∏—à—å <b>${liters.toFixed(2)} –ª</b> —Ç–æ–ø–ª–∏–≤–∞<br>
          –°—Ç–æ–∏–º–æ—Å—Ç—å: <b class="currency-symbol">${cost.toFixed(0)} ${symbol}</b>
        </div>
      `;

      return {cons, distance, price, liters, cost, currency};
    }

    // ========== FAVORITES FUNCTIONS (–°–¢–†–û–ö–ò 362-480) ==========
    function loadFavorites() {
      return JSON.parse(localStorage.getItem('gs-fav-trips') || '[]');
    }
    function saveFavorites(favs) {
      localStorage.setItem('gs-fav-trips', JSON.stringify(favs));
    }

    function openFavModal() {
      const calc = calculate();
      openModal(
        '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏ (–∏–ª–∏ –≥–¥–µ –±—ã–ª):',
        '–ü–æ–µ–∑–¥–∫–∞ #' + (loadFavorites().length + 1),
        (tripName) => {
          let favs = loadFavorites();
          favs.push({
            name: tripName,
            distance: calc.distance,
            price: calc.price,
            type: document.getElementById('driveType').value,
            isRoundTrip: false,
            currency: calc.currency
          });
          saveFavorites(favs);
          renderFavorites();
        }
      );
    }

    function toggleRoundTrip(idx) {
      let favs = loadFavorites();
      favs[idx].isRoundTrip = !favs[idx].isRoundTrip;
      saveFavorites(favs);
      renderFavorites();
    }

    function deleteFavorite(idx) {
      let favs = loadFavorites();
      favs.splice(idx, 1);
      saveFavorites(favs);
      renderFavorites();
    }

    function renderFavorites() {
      const favs = loadFavorites();
      const currentCurrency = getCurrency();
      const consumptions = getConsumptionByType();
      let html = '';
      if (favs.length === 0) {
        html = '<div class="empty-state">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º</div>';
      } else {
        favs.forEach((f, i) => {
          const cons = consumptions[f.type];
          let liters = cons * f.distance / 100;
          let cost = liters * f.price;
          let displayDist = f.distance;
          if (f.isRoundTrip) { 
            liters *= 2; 
            cost *= 2;
            displayDist *= 2;
          }
          const symbol = currencySymbols[currentCurrency];
          const typeLabel = {eco:"üü¢ –≠–∫–æ–Ω–æ–º", normal:"üü° –°—Ä–µ–¥–Ω–∏–π", fast:"üî¥ –ù–∞ –≤—Å–µ –±–∞–±–∫–∏"}[f.type];
          
          html += `
          <div class="fav-entry">
            <div class="fav-entry-info">
              <div class="fav-entry-name">${f.name}</div>
              <div class="fav-entry-stats">
                <span class="tag">${typeLabel}</span>
                ${f.isRoundTrip ? '<span class="tag tag-roundtrip">√ó2 —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ</span>' : ''}
                <br>
                ${liters.toFixed(2)} –ª ‚Ä¢ <span class="currency-symbol">${cost.toFixed(0)} ${symbol}</span> ‚Ä¢ ${displayDist}–∫–º
              </div>
            </div>
            <div class="fav-entry-buttons">
              <button class="small secondary" onclick="toggleRoundTrip(${i})">${f.isRoundTrip?'–û–±—ã—á–Ω–∞—è':'√ó2'}</button>
              <button class="small danger" onclick="deleteFavorite(${i})">‚úï</button>
            </div>
          </div>`;
        });
      }
      document.getElementById('fav-list').innerHTML = html;
    }
    renderFavorites();

    // ========== PROFILE FUNCTIONS (–°–¢–†–û–ö–ò 482-520) ==========
    function updateProfile() {
      const favs = loadFavorites();
      const currentCurrency = getCurrency();
      const symbol = currencySymbols[currentCurrency];
      const consumptions = getConsumptionByType();
      let cnt = favs.length;
      let liters = 0, rub = 0;
      favs.forEach(f => {
        let l = consumptions[f.type] * f.distance / 100 * (f.isRoundTrip ? 2 : 1);
        let r = l * f.price;
        liters += l;
        rub += r;
      });
      document.getElementById('profile-info').innerHTML = `
        <div class="profile-stat">
          <span class="profile-stat-label">üìç –ü–æ–µ–∑–¥–æ–∫:</span>
          <span class="profile-stat-value">${cnt}</span>
        </div>
        <div class="profile-stat">
          <span class="profile-stat-label">‚õΩ –¢–æ–ø–ª–∏–≤–∞ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ:</span>
          <span class="profile-stat-value">${liters.toFixed(1)} –ª</span>
        </div>
        <div class="profile-stat">
          <span class="profile-stat-label">üí∞ –î–µ–Ω–µ–≥ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ:</span>
          <span class="profile-stat-value">${rub.toFixed(0)} ${symbol}</span>
        </div>
      `;

      document.getElementById('profile-nick').innerText = getNick();
      document.getElementById('profile-car').innerText = getCar();
    }

    // ========== TELEGRAM & CLEAR (–°–¢–†–û–ö–ò 522-540) ==========
    function openTelegram() {
      window.open(telegramLink, '_blank');
    }

    function clearAllData() {
      if (confirm('–¢–æ—á–Ω–æ —Å—Ç–µ—Ä–µ—Ç—å –í–°–Å? –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
        localStorage.removeItem('gs-fav-trips');
        localStorage.removeItem('gs-onboarded');
        localStorage.removeItem('gs-nick');
        localStorage.removeItem('gs-car');
        localStorage.removeItem('gs-currency');
        renderFavorites();
        updateProfile();
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞–ª—Å—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–Ω–æ–≤–æ
        location.reload();
      }
    }

    // ========== INIT (–°–¢–†–û–ö–ò 542-545) ==========
    showOnboarding();
  </script>
</body>
</html>
